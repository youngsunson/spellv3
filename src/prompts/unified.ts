// src/prompts/unified.ts

import { DocType, DOC_TYPE_CONFIG } from './core';

export interface UnifiedPromptOptions {
  text: string;
  docType: DocType;
  style?: 'sadhu' | 'cholito' | 'none' | '';
  tone?: string;
}

const toneDescriptions: Record<string, string> = {
  'formal': 'ржЖржирзБрж╖рзНржарж╛ржирж┐ржХ - ржЖржкржирж┐/ржЖржкржирж╛рж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи',
  'informal': 'ржЕржирж╛ржирзБрж╖рзНржарж╛ржирж┐ржХ - рждрзБржорж┐/рждрзЛржорж╛рж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи',
  'professional': 'ржкрзЗрж╢рж╛ржжрж╛рж░ - рж╕рзНржкрж╖рзНржЯ, ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзА ржнрж╛рж╖рж╛',
  'friendly': 'ржмржирзНржзрзБрждрзНржмржкрзВрж░рзНржг - ржЙрж╖рзНржг, ржЖржмрзЗржЧржкрзВрж░рзНржг рж╢ржмрзНржж',
  'respectful': 'рж╕ржорзНржорж╛ржиржЬржиржХ - ржмрж┐ржирзАржд, рж╢рзНрж░ржжрзНржзрж╛рж╕рзВржЪржХ',
  'persuasive': 'ржкрзНрж░ржнрж╛ржмрж╢рж╛рж▓рзА - рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА, ржЬрж░рзБрж░рж┐ ржнрж╛рж╖рж╛',
  'neutral': 'ржирж┐рж░ржкрзЗржХрзНрж╖ - ржмрж╕рзНрждрзБржирж┐рж╖рзНржа, ржЖржмрзЗржЧржорзБржХрзНржд',
  'academic': 'рж╢рж┐ржХрзНрж╖рж╛ржорзВрж▓ржХ - ржкрж░рж┐ржнрж╛рж╖рж╛, рждрзГрждрзАржпрж╝ ржкрзБрж░рзБрж╖'
};

/**
 * рж╕ржм ржХрж┐ржЫрзБ ржПржХржЯрж┐ prompt-ржП - ржПржХржЯрж┐ ржорж╛рждрзНрж░ API call
 */
export const buildUnifiedPrompt = (options: UnifiedPromptOptions): string => {
  const { text, docType, style, tone } = options;
  const docCfg = DOC_TYPE_CONFIG[docType];

  // Word count for validation hint
  const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
  const maxSpellingErrors = Math.min(50, Math.ceil(wordCount * 0.3));

  // Style section instructions
  let styleSection = '';
  if (style && style !== 'none') {
    const styleDesc = style === 'sadhu' 
      ? 'рж╕рж╛ржзрзБ рж░рзАрждрж┐рждрзЗ рж░рзВржкрж╛ржирзНрждрж░ (ржЫрж┐тЖТрждрзЗржЫрж┐, рждрж╛рж░тЖТрждрж╛рж╣рж╛рж░, рж▓тЖТржЗрж▓)'
      : 'ржЪрж▓рж┐ржд рж░рзАрждрж┐рждрзЗ рж░рзВржкрж╛ржирзНрждрж░ (рждрзЗржЫрж┐тЖТржЫрж┐, рждрж╛рж╣рж╛рж░тЖТрждрж╛рж░, ржЗрж▓тЖТрж▓)';
    styleSection = `
@STYLE
${styleDesc}
ржмрж░рзНрждржорж╛ржи|рж╕ржВрж╢рзЛржзрж┐ржд|ржЯрж╛ржЗржк|pos`;
  }

  // Tone section instructions
  let toneSection = '';
  if (tone && toneDescriptions[tone]) {
    toneSection = `
@TONE
${toneDescriptions[tone]}
ржмрж░рзНрждржорж╛ржи|рж╕ржВрж╢рзЛржзрж┐ржд|ржХрж╛рж░ржг|pos`;
  }

  return `ржЖржкржирж┐ ржПржХржЬржи ржжржХрзНрж╖ ржмрж╛ржВрж▓рж╛ ржкрзНрж░рзБржлрж░рж┐ржбрж╛рж░ред
${docCfg.mainHint}

ржЯрзЗржХрзНрж╕ржЯ (${wordCount} рж╢ржмрзНржж):
"""${text}"""

тЪая╕П ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржирж┐ржпрж╝ржо:
тАв ржорзЛржЯ рж╢ржмрзНржж рж╕ржВржЦрзНржпрж╛ ${wordCount}ржЯрж┐ред ржмрж╛ржирж╛ржи ржнрзБрж▓ ржПрж░ ржЪрзЗржпрж╝рзЗ ржмрзЗрж╢рж┐ рж╣рждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛!
тАв рж╕рж░рзНржмрзЛржЪрзНржЪ ${maxSpellingErrors}ржЯрж┐ ржмрж╛ржирж╛ржи ржнрзБрж▓ ржжрзЗржЦрж╛ржмрзЗржи
тАв ржПржХржЗ рж╢ржмрзНржж ржПржХржмрж╛рж░рзЗрж░ ржмрзЗрж╢рж┐ ржжрзЗржмрзЗржи ржирж╛ (no duplicates)
тАв pos = 0-based word index (рж╕рзНржкрзЗрж╕ ржжрж┐ржпрж╝рзЗ ржнрж╛ржЧ ржХрж░рзЗ ржЧрзБржирзБржи)
тАв рж╢ржмрзНржж рж╣рзБржмрж╣рзБ ржЗржиржкрзБржЯ ржерзЗржХрзЗ ржХржкрж┐ ржХрж░рзБржи
тАв рж╢рзБржзрзБржорж╛рждрзНрж░ ржирж┐рж╢рзНржЪрж┐ржд ржнрзБрж▓ ржмрж╛ржирж╛ржи ржзрж░рзБржи
тАв ржирж╛ржо/ржмрзНрж░рзНржпрж╛ржирзНржб/ржЗржВрж░рзЗржЬрж┐/рж╕ржВржЦрзНржпрж╛ ржмрж╛ржж ржжрж┐ржи
тАв рж╢рж┐рж░рзЛржирж╛ржо/рждрж╛рж▓рж┐ржХрж╛ржпрж╝ ржжрж╛ржБржбрж╝рж┐ ржирж╛ ржерж╛ржХрж▓рзЗ рж╕ржорж╕рзНржпрж╛ ржиржпрж╝
тАв рж╕ржирзНржжрзЗрж╣ рж╣рж▓рзЗ ржнрзБрж▓ ржзрж░ржмрзЗржи ржирж╛

ЁЯУд TOON ржлрж░ржорзНржпрж╛ржЯрзЗ ржЙрждрзНрждрж░ ржжрж┐ржи:

@SPELLING
ржнрзБрж▓|рж╕ржарж┐ржХрзз,рж╕ржарж┐ржХрзи|pos

@MIXING
detected:true/false
style:ржЪрж▓рж┐ржд/рж╕рж╛ржзрзБ
reason:ржХрж╛рж░ржг
@CORRECTIONS
ржмрж░рзНрждржорж╛ржи|рж╕ржВрж╢рзЛржзржи|ржЯрж╛ржЗржк|pos

@PUNCTUATION
issue:рж╕ржорж╕рзНржпрж╛
cur:ржмрж╛ржХрзНржп
fix:рж╕ржВрж╢рзЛржзрж┐ржд
exp:ржмрзНржпрж╛ржЦрзНржпрж╛
pos:0
---

@EUPHONY
рж╢ржмрзНржж|ржмрж┐ржХрж▓рзНржкрзз,ржмрж┐ржХрж▓рзНржкрзи|ржХрж╛рж░ржг|pos
${styleSection}
${toneSection}

@CONTENT
type:рж▓рзЗржЦрж╛рж░ ржзрж░ржи (ржпрзЗржоржи: ржкрзНрж░ржмржирзНржз, ржЪрж┐ржарж┐, ржмрзНрж▓ржЧ, ржЧрж▓рзНржк ржЗрждрзНржпрж╛ржжрж┐)
desc:ржПржХ ржмрж╛ржХрзНржпрзЗ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржмрж░рзНржгржирж╛
missing:ржЕржирзБржкрж╕рзНржерж┐ржд ржЙржкрж╛ржжрж╛ржирзз,ржЕржирзБржкрж╕рзНржерж┐ржд ржЙржкрж╛ржжрж╛ржирзи
tips:ржЙржирзНржирждрж┐рж░ ржкрж░рж╛ржорж░рзНрж╢рзз,ржкрж░рж╛ржорж░рзНрж╢рзи

${docCfg.contentHint}

тЬЕ рж╕ржм section ржЕржмрж╢рзНржпржЗ ржжрж┐ржи (ржЦрж╛рж▓рж┐ рж╣рж▓рзЗржУ @SECTION рж╣рзЗржбрж╛рж░ ржжрж┐ржи)
тЬЕ @CONTENT рж╕ржмрж╕ржоржпрж╝ ржкрзВрж░ржг ржХрж░рзБржи
тЬЕ ржПржХржЗ рж╢ржмрзНржж рж░рж┐ржкрж┐ржЯ ржХрж░ржмрзЗржи ржирж╛`;
};
