// src/prompts/unified.ts

import { DocType, DOC_TYPE_CONFIG } from './core';

export interface UnifiedPromptOptions {
  text: string;
  docType: DocType;
  style?: 'sadhu' | 'cholito' | 'none' | '';
  tone?: string;
}

const toneDescriptions: Record<string, string> = {
  'formal': 'ржЖржирзБрж╖рзНржарж╛ржирж┐ржХ - ржЖржкржирж┐/ржЖржкржирж╛рж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи',
  'informal': 'ржЕржирж╛ржирзБрж╖рзНржарж╛ржирж┐ржХ - рждрзБржорж┐/рждрзЛржорж╛рж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи',
  'professional': 'ржкрзЗрж╢рж╛ржжрж╛рж░ - рж╕рзНржкрж╖рзНржЯ, ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзА ржнрж╛рж╖рж╛',
  'friendly': 'ржмржирзНржзрзБрждрзНржмржкрзВрж░рзНржг - ржЙрж╖рзНржг, ржЖржмрзЗржЧржкрзВрж░рзНржг рж╢ржмрзНржж',
  'respectful': 'рж╕ржорзНржорж╛ржиржЬржиржХ - ржмрж┐ржирзАржд, рж╢рзНрж░ржжрзНржзрж╛рж╕рзВржЪржХ',
  'persuasive': 'ржкрзНрж░ржнрж╛ржмрж╢рж╛рж▓рзА - рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА, ржЬрж░рзБрж░рж┐ ржнрж╛рж╖рж╛',
  'neutral': 'ржирж┐рж░ржкрзЗржХрзНрж╖ - ржмрж╕рзНрждрзБржирж┐рж╖рзНржа, ржЖржмрзЗржЧржорзБржХрзНржд',
  'academic': 'рж╢рж┐ржХрзНрж╖рж╛ржорзВрж▓ржХ - ржкрж░рж┐ржнрж╛рж╖рж╛, рждрзГрждрзАржпрж╝ ржкрзБрж░рзБрж╖'
};

/**
 * рж╕ржм ржХрж┐ржЫрзБ ржПржХржЯрж┐ prompt-ржП - ржПржХржЯрж┐ ржорж╛рждрзНрж░ API call
 */
export const buildUnifiedPrompt = (options: UnifiedPromptOptions): string => {
  const { text, docType, style, tone } = options;
  const docCfg = DOC_TYPE_CONFIG[docType];

  // Word count for validation hint
  const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
  const maxSpellingErrors = Math.min(50, Math.ceil(wordCount * 0.3));

  // Style section instructions
  let styleSection = '';
  if (style && style !== 'none') {
    const styleDesc = style === 'sadhu' 
      ? 'рж╕рж╛ржзрзБ рж░рзАрждрж┐рждрзЗ рж░рзВржкрж╛ржирзНрждрж░ ржХрж░рзБржи (ржЫрж┐тЖТрждрзЗржЫрж┐, рждрж╛рж░тЖТрждрж╛рж╣рж╛рж░, рж▓тЖТржЗрж▓, ржХрж░рзЗтЖТржХрж░рж┐ржпрж╝рж╛)'
      : 'ржЪрж▓рж┐ржд рж░рзАрждрж┐рждрзЗ рж░рзВржкрж╛ржирзНрждрж░ ржХрж░рзБржи (рждрзЗржЫрж┐тЖТржЫрж┐, рждрж╛рж╣рж╛рж░тЖТрждрж╛рж░, ржЗрж▓тЖТрж▓, ржХрж░рж┐ржпрж╝рж╛тЖТржХрж░рзЗ)';
    styleSection = `
@STYLE
${styleDesc}
ржлрж░ржорзНржпрж╛ржЯ: ржмрж░рзНрждржорж╛ржи|рж╕ржВрж╢рзЛржзрж┐ржд|ржЯрж╛ржЗржк|pos
ржЙржжрж╛рж╣рж░ржг: ржХрж░рж┐рждрзЗржЫрж┐|ржХрж░ржЫрж┐|ржХрзНрж░рж┐ржпрж╝рж╛ржкржж|5`;
  }

  // Tone section instructions
  let toneSection = '';
  if (tone && toneDescriptions[tone]) {
    toneSection = `
@TONE
${toneDescriptions[tone]}
ржлрж░ржорзНржпрж╛ржЯ: ржмрж░рзНрждржорж╛ржи|рж╕ржВрж╢рзЛржзрж┐ржд|ржХрж╛рж░ржг|pos
ржЙржжрж╛рж╣рж░ржг: рждрзБржорж┐|ржЖржкржирж┐|рж╕ржорзНржорж╛ржирж╕рзВржЪржХ рж╕ржорзНржмрзЛржзржи|0`;
  }

  return `ржЖржкржирж┐ ржПржХржЬржи ржжржХрзНрж╖ ржмрж╛ржВрж▓рж╛ ржкрзНрж░рзБржлрж░рж┐ржбрж╛рж░ ржУ ржнрж╛рж╖рж╛ ржмрж┐рж╢рзЗрж╖ржЬрзНржЮред
${docCfg.mainHint}

ЁЯУЭ ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗрж░ ржЬржирзНржп ржЯрзЗржХрзНрж╕ржЯ (${wordCount} рж╢ржмрзНржж):
"""
${text}
"""

тХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХР
ЁЯУЛ ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗрж░ ржирж┐рж░рзНржжрзЗрж╢ржирж╛:
тХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХР

ЁЯФ┤ рзз. ржмрж╛ржирж╛ржи ржнрзБрж▓ (@SPELLING):
- рж╢рзБржзрзБржорж╛рждрзНрж░ ржирж┐рж╢рзНржЪрж┐ржд ржмрж╛ржирж╛ржи ржнрзБрж▓ ржзрж░рзБржи
- ржпрзБржХрзНрждрж╛ржХрзНрж╖рж░рзЗрж░ ржнрзБрж▓, ржгрждрзНржм-рж╖рждрзНржм ржмрж┐ржзрж╛ржи рж▓ржЩрзНржШржи, ржЯрж╛ржЗржкрзЛ
- ржирж╛ржо, ржмрзНрж░рзНржпрж╛ржирзНржб, ржЗржВрж░рзЗржЬрж┐ рж╢ржмрзНржж ржмрж╛ржж ржжрж┐ржи
- рж╕рж░рзНржмрзЛржЪрзНржЪ ${maxSpellingErrors}ржЯрж┐

ЁЯЯа рзи. ржмрж┐рж░рж╛ржо ржЪрж┐рж╣рзНржи (@PUNCTUATION):
- ржжрж╛ржБржбрж╝рж┐ (ред) ржирж╛ ржерж╛ржХрж▓рзЗ: ржмрж╛ржХрзНржп рж╢рзЗрж╖рзЗ ржжрж╛ржБржбрж╝рж┐ ржирзЗржЗ
- ржХржорж╛ (,) ржкрзНрж░ржпрж╝рзЛржЬржи: рждрж╛рж▓рж┐ржХрж╛ ржмрж╛ ржмрж┐рж░рждрж┐рждрзЗ ржХржорж╛ ржирзЗржЗ
- ржкрзНрж░рж╢рзНржиржмрзЛржзржХ ржЪрж┐рж╣рзНржи (?): ржкрзНрж░рж╢рзНржиржмрж╛ржЪржХ ржмрж╛ржХрзНржпрзЗ ржкрзНрж░рж╢рзНржиржЪрж┐рж╣рзНржи ржирзЗржЗ
- ржмрж┐рж╕рзНржоржпрж╝ржмрзЛржзржХ ржЪрж┐рж╣рзНржи (!): ржЖржмрзЗржЧржкрзВрж░рзНржг ржмрж╛ржХрзНржпрзЗ ржмрж┐рж╕рзНржоржпрж╝ржЪрж┐рж╣рзНржи ржирзЗржЗ
- ржЙржжрзНржзрзГрждрж┐ ржЪрж┐рж╣рзНржи ("): рж╕ржВрж▓рж╛ржкрзЗ ржЙржжрзНржзрзГрждрж┐ ржЪрж┐рж╣рзНржи ржирзЗржЗ
- ржХрзЛрж▓ржи (:) ржУ рж╕рзЗржорж┐ржХрзЛрж▓ржи (;) ржПрж░ рж╕ржарж┐ржХ ржмрзНржпржмрж╣рж╛рж░
тЪая╕П рж╢рж┐рж░рзЛржирж╛ржо ржУ рждрж╛рж▓рж┐ржХрж╛ржпрж╝ ржжрж╛ржБржбрж╝рж┐ ржирж╛ ржерж╛ржХрж▓рзЗ ржнрзБрж▓ ржиржпрж╝

ЁЯЯг рзй. рж╢рзНрж░рзБрждрж┐ржоржзрзБрж░рждрж╛ (@EUPHONY):
- ржПржХржЗ рж╢ржмрзНржжрзЗрж░ ржкрзБржирж░рж╛ржмрзГрждрзНрждрж┐: ржмрж╛рж░ржмрж╛рж░ ржПржХржЗ рж╢ржмрзНржж ржмрзНржпржмрж╣рж╛рж░
- ржХрж╛ржирзЗ ржХржарж┐ржи рж╢ржмрзНржж: ржЕрждрж┐рж░рж┐ржХрзНржд ржЬржЯрж┐рж▓ ржмрж╛ ржнрж╛рж░рзА рж╢ржмрзНржж
- ржмрж╛ржХрзНржпрзЗрж░ ржЫржирзНржж: ржмрж╛ржХрзНржп ржЦрзБржм ржжрзАрж░рзНржШ ржмрж╛ ржЕрж╕ржорж╛ржи
- рж╢ржмрзНржжржЪржпрж╝ржи: ржЖрж░ржУ рж╕рж╣ржЬ/рж╕рзБржирзНржжрж░ ржмрж┐ржХрж▓рзНржк ржЖржЫрзЗ
ржЙржжрж╛рж╣рж░ржг: "ржЕрждрзНржпржзрж┐ржХ" тЖТ "ржмрзЗрж╢рж┐", "рж╕рж░рзНржмржжрж╛ рж╕рж░рзНржмржжрж╛" тЖТ "рж╕ржмрж╕ржоржпрж╝"

ЁЯЯв рзк. ржнрж╛рж╖рж╛рж░рзАрждрж┐ ржорж┐рж╢рзНрж░ржг (@MIXING):
- рж╕рж╛ржзрзБ ржУ ржЪрж▓рж┐ржд рж░рзАрждрж┐ ржПржХрж╕рж╛ржерзЗ ржмрзНржпржмрж╣рзГржд рж╣рж▓рзЗ detected:true
- ржпрзЗржоржи: "ржХрж░рж┐ржпрж╝рж╛ржЫрж┐" (рж╕рж╛ржзрзБ) + "ржХрж░рзЗ" (ржЪрж▓рж┐ржд) ржПржХржЗ ржЯрзЗржХрзНрж╕ржЯрзЗ

ЁЯФ╡ рзл. ржХржиржЯрзЗржирзНржЯ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг (@CONTENT):
- рж▓рзЗржЦрж╛рж░ ржзрж░ржи ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рзБржи
- ржХрзА ржХрзА ржЕржирзБржкрж╕рзНржерж┐ржд рждрж╛ ржмрж▓рзБржи
- ржЙржирзНржирждрж┐рж░ ржкрж░рж╛ржорж░рзНрж╢ ржжрж┐ржи

тХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХР
ЁЯУд ржЖржЙржЯржкрзБржЯ ржлрж░ржорзНржпрж╛ржЯ (TOON - рж╢рзБржзрзБ ржПржЯрж┐, ржЕржирзНржп ржХрж┐ржЫрзБ ржиржпрж╝):
тХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХР

@SPELLING
ржнрзБрж▓_рж╢ржмрзНржж|рж╕ржарж┐ржХрзз,рж╕ржарж┐ржХрзи|pos
ржнрзБрж▓_рж╢ржмрзНржжрзи|рж╕ржарж┐ржХ|pos

@PUNCTUATION
issue:ржмрж╛ржХрзНржпрзЗрж░ рж╢рзЗрж╖рзЗ ржжрж╛ржБржбрж╝рж┐ ржирзЗржЗ
cur:ржПржЦрж╛ржирзЗ ржорзВрж▓ ржмрж╛ржХрзНржпржЯрж┐ рж▓рж┐ржЦрзБржи
fix:ржПржЦрж╛ржирзЗ ржорзВрж▓ ржмрж╛ржХрзНржпржЯрж┐ рж▓рж┐ржЦрзБржиред
exp:ржкрзВрж░рзНржг ржмрж╛ржХрзНржпрзЗрж░ рж╢рзЗрж╖рзЗ ржжрж╛ржБржбрж╝рж┐ ржкрзНрж░ржпрж╝рзЛржЬржи
pos:0
---
issue:ржХржорж╛ ржкрзНрж░ржпрж╝рзЛржЬржи
cur:ржЖржо ржЬрж╛ржо ржХрж╛ржБржарж╛рж▓ рж▓рж┐ржЪрзБ
fix:ржЖржо, ржЬрж╛ржо, ржХрж╛ржБржарж╛рж▓, рж▓рж┐ржЪрзБ
exp:рждрж╛рж▓рж┐ржХрж╛ржпрж╝ ржкрзНрж░рждрж┐ржЯрж┐ ржЖржЗржЯрзЗржорзЗрж░ ржкрж░ ржХржорж╛ ржжрж┐рждрзЗ рж╣ржпрж╝
pos:5

@EUPHONY
ржкрзБржирж░рж╛ржмрзГрждрзНржд_рж╢ржмрзНржж|ржмрж┐ржХрж▓рзНржкрзз,ржмрж┐ржХрж▓рзНржкрзи|рж╢ржмрзНржжржЯрж┐ ржмрж╛рж░ржмрж╛рж░ ржПрж╕рзЗржЫрзЗ|pos
ржЬржЯрж┐рж▓_рж╢ржмрзНржж|рж╕рж╣ржЬ_ржмрж┐ржХрж▓рзНржк|рж╕рж╣ржЬ рж╢ржмрзНржж ржмрзЗрж╢рж┐ ржмрзЛржзржЧржорзНржп|pos

@MIXING
detected:true
style:ржЪрж▓рж┐ржд
reason:рж╕рж╛ржзрзБ ржУ ржЪрж▓рж┐ржд рж░рзАрждрж┐ ржорж┐рж╢рзНрж░рж┐ржд ржЖржЫрзЗ
@CORRECTIONS
ржХрж░рж┐ржпрж╝рж╛ржЫрж┐|ржХрж░рзЗржЫрж┐|рж╕рж╛ржзрзБтЖТржЪрж▓рж┐ржд|pos
рждрж╛рж╣рж╛рж░|рждрж╛рж░|рж╕рж╛ржзрзБтЖТржЪрж▓рж┐ржд|pos
${styleSection}
${toneSection}

@CONTENT
type:рж▓рзЗржЦрж╛рж░ ржзрж░ржи (ржкрзНрж░ржмржирзНржз/ржЪрж┐ржарж┐/ржЧрж▓рзНржк/ржмрзНрж▓ржЧ/рж░рж┐ржкрзЛрж░рзНржЯ)
desc:ржПржХ ржмрж╛ржХрзНржпрзЗ рж▓рзЗржЦрж╛рж░ рж╕рж╛рж░рж╛ржВрж╢
missing:ржЕржирзБржкрж╕рзНржерж┐рждрзз,ржЕржирзБржкрж╕рзНржерж┐рждрзи,ржЕржирзБржкрж╕рзНржерж┐рждрзй
tips:ржкрж░рж╛ржорж░рзНрж╢рзз,ржкрж░рж╛ржорж░рзНрж╢рзи

тХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХР
тЪая╕П ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржирж┐ржпрж╝ржо:
тХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХР
тАв pos = 0-based word index (ржкрзНрж░ржержо рж╢ржмрзНржж = 0)
тАв ржкрзНрж░рждрж┐ржЯрж┐ рж╕рзЗржХрж╢ржи ржЕржмрж╢рзНржпржЗ ржжрж┐ржи (ржЦрж╛рж▓рж┐ рж╣рж▓рзЗржУ @SECTION рж╣рзЗржбрж╛рж░ ржжрж┐ржи)
тАв @PUNCTUATION ржП ржкрзНрж░рждрж┐ржЯрж┐ рж╕ржорж╕рзНржпрж╛рж░ ржЬржирзНржп issue, cur, fix, exp, pos ржжрж┐ржи
тАв @EUPHONY рждрзЗ рж╢ржмрзНржж ржкрзБржирж░рж╛ржмрзГрждрзНрждрж┐ ржУ ржХржарж┐ржи рж╢ржмрзНржж ржЦрзБржБржЬрзБржи
тАв @CONTENT рж╕ржмрж╕ржоржпрж╝ ржкрзВрж░ржг ржХрж░рзБржи
тАв ржПржХржЗ рж╢ржмрзНржж/ржмрж╛ржХрзНржп рж░рж┐ржкрж┐ржЯ ржХрж░ржмрзЗржи ржирж╛
тАв рж╕ржирзНржжрзЗрж╣ рж╣рж▓рзЗ ржнрзБрж▓ ржзрж░ржмрзЗржи ржирж╛`;
};
